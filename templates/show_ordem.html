<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RS Car Automotive</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <header>
    <nav class="navbar navbar-expand-lg bg-body-tertiary mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">RS Car Automotive</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarTogglerDemo02"
          aria-controls="navbarTogglerDemo02"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="/register">Cadastro</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/order">Pedido</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" aria-disabled="true" href="/status">Status</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" aria-disabled="true" href="/search">Busca</a>
            </li>
          </ul>
          <a class="nav-link" href="/">Logout</a>
        </div>
      </div>
    </nav>
  </header>
  <body>
    <div class="container">
      <h2>RS Car Automotive</h2>

      <!-- Client Details Form -->
      <form
        id="ordemForm"
        action="{{ url_for('show_ordem') }}"
        method="POST"
        class="input-group mb3"
      >
        <fieldset class="ordem-field">
          <legend>Ordem de Servico</legend>

          <label for="client_id_ordem">ID Client:</label>
          <input
            type="text"
            id="client_id_ordem"
            name="client_id_ordem"
            readonly
          />
          <br />
          <label for="placa_ordem">Placa do Veiculo:</label>
          <input type="text" id="placa_ordem" name="placa_ordem" readonly />
          <br />
          <label for="tipo_servico">Tipo de Serviço:</label>
          <select id="tipo_servico" name="tipo_servico">
            {% for tipo in tiposervicos %}
            <option value="{{ tipo.id }}">
              {{ tipo.nome }} - R$ {{ tipo.valor }}
            </option>
            {% endfor %}
          </select>
          <br />
        </fieldset>
      </form>

      <fieldset class="table-order-field">
        <div class="table-container">
          <table class="table table-primary table-striped">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Id Serviço</th>
                <th scope="col">Nome do Serviço</th>
                <th scope="col">Valores</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">1</th>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <th scope="row">2</th>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <th scope="row">3</th>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <th scope="row">4</th>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <th scope="row">5</th>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <th scope="row"></th>
                <td></td>
                <td>Subtotal :</td>
                <td></td>
              </tr>
            </tbody>
          </table>
          <div>
            <button
              type="submit"
              id="abrirordem"
              class="btn btn-outline-secondary"
            >
              Sair
            </button>
            <button
              type="submit"
              id="abrirordem"
              class="btn btn-outline-success"
            >
              Confirmar Ordem
            </button>
          </div>
        </div>
      </fieldset>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="static/script.js"></script>

    <script>
      // Fetch data for populating fields
      $.ajax({
        url: '/show_ordem',
        method: 'GET',
        success: function (response) {
          // Populate client_id_ordem and placa_ordem fields
          $('#client_id_ordem').val(response.last_client_id);
          $('#placa_ordem').val(response.last_placa);

          // Populate tipo_servico select options
          for (var i = 0; i < response.tiposervicos.length; i++) {
            $('#tipo_servico').append(
              $('<option>', {
                value: response.tiposervicos[i].id,
                text:
                  response.tiposervicos[i].nome +
                  ' - R$ ' +
                  response.tiposervicos[i].valor,
              })
            );
          }
        },
        error: function (xhr, status, error) {
          console.error('Failed to retrieve data:', error);
        },
      });

      // Bind submit event handler to the form with id 'ordemForm'
      $('#ordemForm').submit(function (event) {
        // Prevent the default form submission behavior
        event.preventDefault();

        // Serialize form data
        var formData = $(this).serialize();

        // Send form data via AJAX to a different endpoint for form submission
        $.ajax({
          url: '/submit_order', // Change the endpoint to handle form submission
          method: 'POST',
          data: formData,
          success: function (response) {
            // Show modal with success message
            openModal4(response.placa); // Ensure that placa is present in the response
            // Reset the form
            $('#ordemForm')[0].reset();
          },
          error: function (xhr, status, error) {
            // Show modal with error message
            openModal4(
              null,
              'Erro ao enviar o formulário. Por favor, tente novamente mais tarde.'
            );
          },
        });
      });
    </script>
  </body>
</html>
